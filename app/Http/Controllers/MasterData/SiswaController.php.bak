<?php

namespace App\Http\Controllers\MasterData;

use App\Http\Controllers\Controller;
use App\Services\Siswa\SiswaService;
use App\Data\Siswa\SiswaData;
use App\Data\Siswa\SiswaFilterData;
use App\Http\Requests\Siswa\CreateSiswaRequest;
use App\Http\Requests\Siswa\UpdateSiswaRequest;
use App\Http\Requests\Siswa\FilterSiswaRequest;
use Illuminate\Http\RedirectResponse;
use Illuminate\View\View;

class SiswaController extends Controller
{
    public function __construct(
        private SiswaService $siswaService
    ) {}

    public function index(FilterSiswaRequest $request): View
    {
        $filterData = $request->getFilterData();
        
        $user = auth()->user();
        $role = $user->effectiveRoleName() ?? $user->role?->nama_role;
        
        if ($role === 'Kaprodi' && !isset($filterData['jurusan_id'])) {
            $jurusanKaprodi = \App\Models\Jurusan::where('kaprodi_user_id', $user->id)->first();
            if ($jurusanKaprodi) {
                $filterData['jurusan_id'] = $jurusanKaprodi->id;
            }
        }
        
        if ($role === 'Wali Kelas' && !isset($filterData['kelas_id'])) {
            $kelasWali = \App\Models\Kelas::where('wali_kelas_user_id', $user->id)->first();
            if ($kelasWali) {
                $filterData['kelas_id'] = $kelasWali->id;
            }
        }
        
        $filters = SiswaFilterData::from($filterData);

        $siswa = $this->siswaService->getFilteredSiswa($filters);

        $allKelas = $this->siswaService->getAllKelasForFilter();
        $allJurusan = $this->siswaService->getAllJurusanForFilter();

        return view('siswa.index', compact('siswa', 'allKelas', 'allJurusan'));
    }

    public function create(): View
    {
        $kelas = $this->siswaService->getAllKelas();
        $waliMurid = $this->siswaService->getAvailableWaliMurid();

        return view('siswa.create', compact('kelas', 'waliMurid'));
    }

    public function store(CreateSiswaRequest $request): RedirectResponse
    {
        $siswaData = SiswaData::from($request->validated());

        $result = $this->siswaService->createSiswa(
            $siswaData,
            $request->boolean('create_wali')
        );

        if ($result['wali_credentials']) {
            session()->flash('wali_created', $result['wali_credentials']);
        }

        return redirect()
            ->route('siswa.index')
            ->with('success', 'Data Siswa Berhasil Ditambahkan');
    }

    public function show(int $id): View
    {
        $result = $this->siswaService->getSiswaDetail($id);

        return view('siswa.show', [
            'siswa' => $result['siswa'],
            'totalPoin' => $result['totalPoin'],
            'pembinaanRekomendasi' => $result['pembinaanRekomendasi'],
        ]);
    }

    public function edit(int $id): View
    {
        $siswa = $this->siswaService->getSiswaForEdit($id);
        $kelas = $this->siswaService->getAllKelas();
        $waliMurid = $this->siswaService->getAvailableWaliMurid();

        return view('siswa.edit', compact('siswa', 'kelas', 'waliMurid'));
    }

    public function update(UpdateSiswaRequest $request, int $id): RedirectResponse
    {
        if ($request->isWaliKelas()) {
            $existingSiswa = $this->siswaService->getSiswaForEdit($id);
            $mergedData = array_merge(
                $existingSiswa->toArray(),
                $request->validated()
            );
            $siswaData = SiswaData::from($mergedData);
        } else {
            $siswaData = SiswaData::from($request->validated());
        }

        $this->siswaService->updateSiswa(
            $id,
            $siswaData,
            $request->isWaliKelas()
        );

        return redirect()
            ->route('siswa.index')
            ->with('success', 'Data siswa berhasil diperbarui.');
    }

    public function destroy(int $id): RedirectResponse
{
    request()->validate([
        'alasan_keluar' => 'required|in:Alumni,Dikeluarkan,Pindah Sekolah,Lainnya',
        'keterangan_keluar' => 'nullable|string|max:500',
    ], [
        'alasan_keluar.required' => 'Alasan keluar harus dipilih.',
    ]);
    
    $this->siswaService->deleteSiswa(
        $id,
        request('alasan_keluar'),
        request('keterangan_keluar')
    );

    return redirect()
        ->route('siswa.index')
        ->with('success', 'Data Siswa Berhasil Dihapus');
}

    public function bulkCreate(): View
    {
        $kelas = $this->siswaService->getAllKelas();

        return view('siswa.bulk_create', compact('kelas'));
    }

    public function bulkStore(\Illuminate\Http\Request $request): RedirectResponse
    {
        try {
            $request->validate([
                'kelas_id' => 'required|exists:kelas,id',
                'bulk_file' => 'nullable|file|mimes:csv,txt,xlsx|max:2048',
                'bulk_data' => 'nullable|string',
            ]);

            $kelasId = $request->input('kelas_id');
            $createWaliAll = $request->boolean('create_wali_all');
            $rows = [];

            if ($request->hasFile('bulk_file')) {
                $rows = $this->parseFileUpload($request->file('bulk_file'));
            } elseif ($request->filled('bulk_data')) {
                $rows = $this->parseManualData($request->input('bulk_data'));
            } else {
                return redirect()
                    ->back()
                    ->with('error', 'Silakan upload file atau isi tabel manual.');
            }

            $validRows = [];
            $errors = [];
            $seenNisns = [];
            
            foreach ($rows as $index => $row) {
                $lineNumber = $index + 1;
                
                if (empty($row['nisn']) || empty($row['nama'])) {
                    $errors[] = "Baris {$lineNumber}: NISN dan Nama harus diisi";
                    continue;
                }
                
                if (!preg_match('/^\d{10}$/', $row['nisn'])) {
                    $errors[] = "Baris {$lineNumber}: NISN harus 10 digit angka";
                    continue;
                }
                
                if (isset($seenNisns[$row['nisn']])) {
                    $errors[] = "Baris {$lineNumber}: NISN {$row['nisn']} duplicate dengan baris {$seenNisns[$row['nisn']]}";
                    continue;
                }
                
                if (\App\Models\Siswa::where('nisn', $row['nisn'])->exists()) {
                    $errors[] = "Baris {$lineNumber}: NISN {$row['nisn']} sudah terdaftar di database";
                    continue;
                }
                
                $seenNisns[$row['nisn']] = $lineNumber;
                
                $validRows[] = $row;
            }

            if (empty($validRows)) {
                return redirect()
                    ->back()
                    ->with('error', 'Tidak ada data siswa yang valid untuk diproses.')
                    ->with('bulk_errors', $errors);
            }

            $result = $this->siswaService->bulkCreateSiswa($validRows, $kelasId, $createWaliAll);

            $successCount = $result['success_count'];
            $message = "Berhasil menambahkan {$successCount} siswa.";
            
            if (!empty($errors)) {
                $message .= " Beberapa baris dilewati karena error.";
            }

            return redirect()
                ->route('siswa.index')
                ->with('success', $message)
                ->with('bulk_errors', $errors)
                ->with('wali_credentials', $result['wali_credentials'] ?? []);
                
        } catch (\Exception $e) {
            \Log::error('Bulk create siswa error: ' . $e->getMessage());
            
            return redirect()
                ->back()
                ->with('error', 'Gagal memproses bulk create: ' . $e->getMessage());
        }
    }

    private function parseFileUpload($file): array
    {
        $rows = [];
        $extension = $file->getClientOriginalExtension();
        
        if ($extension === 'csv' || $extension === 'txt') {
            $handle = fopen($file->getRealPath(), 'r');
            $header = fgetcsv($handle); 
            
            while (($data = fgetcsv($handle)) !== false) {
                if (count($data) >= 2) {
                    $rows[] = [
                        'nisn' => trim($data[0] ?? ''),
                        'nama' => trim($data[1] ?? ''),
                        'nomor_hp_wali_murid' => trim($data[2] ?? ''),
                    ];
                }
            }
            fclose($handle);
        } elseif ($extension === 'xlsx') {
            throw new \Exception('Format XLSX memerlukan library tambahan. Gunakan format CSV atau input manual.');
        }
        
        return $rows;
    }

    private function parseManualData(string $data): array
    {
        $rows = [];
        $lines = explode("\n", $data);
        
        foreach ($lines as $line) {
            $line = trim($line);
            if (empty($line)) continue;
            
            $parts = preg_split('/[;\t]/', $line);
            
            if (count($parts) >= 2) {
                $rows[] = [
                    'nisn' => trim($parts[0] ?? ''),
                    'nama' => trim($parts[1] ?? ''),
                    'nomor_hp_wali_murid' => trim($parts[2] ?? ''),
                ];
            }
        }
        
        return $rows;
    }

    /**
     * Bulk delete siswa by kelas.
     * 
     * Clean Controller Pattern:
     * - Validate request
     * - Delegate to service
     * - Return response
     */
    public function bulkDelete(\Illuminate\Http\Request $request): RedirectResponse
    {
        try {
            $request->validate([
    'kelas_id' => 'required|exists:kelas,id',
    'confirm' => 'required|accepted',
    'alasan_keluar' => 'required|in:Alumni,Dikeluarkan,Pindah Sekolah,Lainnya',
    'keterangan_keluar' => 'nullable|string|max:500',
], [
    'confirm.accepted' => 'Anda harus mencentang kotak konfirmasi.',
    'alasan_keluar.required' => 'Alasan keluar harus dipilih.',
]);
            
            $kelasId = $request->input('kelas_id');
            $kelas = \App\Models\Kelas::findOrFail($kelasId);
            
            $result = $this->siswaService->bulkDeleteByKelas($kelasId, [
    'deleteOrphanedWali' => $request->boolean('delete_orphaned_wali'),
    'alasanKeluar' => $request->input('alasan_keluar'),
    'keteranganKeluar' => $request->input('keterangan_keluar'),
]);
            
            $message = "Berhasil menghapus {$result['count']} siswa dari kelas {$kelas->nama_kelas}.";
            if ($result['orphaned_wali_deleted'] > 0) {
                $message .= " {$result['orphaned_wali_deleted']} akun Wali Murid orphaned juga dihapus.";
            }
            
            return redirect()->route('siswa.index')->with('success', $message);
                
        } catch (\Exception $e) {
            \Log::error('Bulk delete siswa error: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Gagal menghapus siswa: ' . $e->getMessage());
        }
    }

    /**
     * Show deleted siswa page.
     */
    public function showDeleted(\Illuminate\Http\Request $request): View
    {
        $filters = [
            'alasan_keluar' => $request->input('alasan_keluar'),
            'kelas_id' => $request->input('kelas_id'),
            'search' => $request->input('search'),
        ];
        
        $deletedSiswa = $this->siswaService->getDeletedSiswa($filters);
        
        // Get kelas for filter dropdown
        $allKelas = $this->siswaService->getAllKelasForFilter();
        
        // Alasan keluar options
        $alasanOptions = ['Alumni', 'Dikeluarkan', 'Pindah Sekolah', 'Lainnya'];
        
        return view('siswa.deleted', compact('deletedSiswa', 'allKelas', 'alasanOptions', 'filters'));
    }
    
    /**
     * Restore deleted siswa.
     */
    public function restore(int $id): RedirectResponse
    {
        try {
            $this->siswaService->restoreSiswa($id);
            
            return redirect()
                ->route('siswa.deleted')
                ->with('success', 'Siswa berhasil di-restore beserta semua data terkait.');
                
        } catch (\Exception $e) {
            \Log::error('Restore siswa error: ' . $e->getMessage());
            
            return redirect()
                ->back()
                ->with('error', 'Gagal restore siswa: ' . $e->getMessage());
        }
    }

}
    /**
     * Permanent delete single siswa (force delete from database).
     */
    public function forceDestroy(int $id): RedirectResponse
    {
        try {
            request()->validate([
                'confirm_permanent' => 'required|accepted',
            ], [
                'confirm_permanent.accepted' => 'Anda harus confirm permanent delete.',
            ]);
            
            $this->siswaService->permanentDeleteSiswa($id);
            
            return redirect()
                ->route('siswa.deleted')
                ->with('success', 'Siswa berhasil dihapus PERMANENT dari database.');
                
        } catch (\Exception $e) {
            \Log::error('Permanent delete error: ' . $e->getMessage());
            
            return redirect()
                ->back()
                ->with('error', 'Gagal permanent delete: ' . $e->getMessage());
        }
    }
    
    /**
     * Bulk permanent delete.
     */
    public function bulkForceDelete(\Illuminate\Http\Request $request): RedirectResponse
    {
        try {
            $request->validate([
                'siswa_ids' => 'required|array',
                'siswa_ids.*' => 'integer',
                'confirm_permanent' => 'required|accepted',
            ]);
            
            $count = $this->siswaService->bulkPermanentDelete($request->input('siswa_ids'));
            
            return redirect()
                ->route('siswa.deleted')
                ->with('success', "Berhasil PERMANENT DELETE {$count} siswa dari database.");
                
        } catch (\Exception $e) {
            return redirect()
                ->back()
                ->with('error', 'Gagal bulk permanent delete: ' . $e->getMessage());
        }
    }
}
